# <!-- 간단한 커널 컴파일 -->

# 간단한 커널 컴파일

### 커널(kernel)과 모듈(Module)의 개념을 간단히 파악한 후 CentOS가 기본적으로 가진 커널을 최신 커널로 업그레이드 해보자

### 중요한 요소가 새로 나왔다 바로 '모듈'이라는 개념이다. 우선 커널의 가장 큰 역할은 '하드웨어 지원'이라는 점을 상기하자

### 초창기 커널은 지원할 하드웨어가 그리 많지 않았으므로 커널에 하드웨어를 지원하는 코드를 모두 넣어놓았다. 그런데 시간이 지날수록 지원해야 할 하드웨어가 만아져 커널에 넣어야 할 코드가 많아 졌고 커널이 점점 커졌다. 커널이 커지면 컴퓨터의 지원을 많이 차지해 결국 운영체제를 무겁게 만드는 결과를 낳는다.

### 그런데 커널에 들어있는 하드웨어를 제어하는 코드 중 어떤 부분은 항상 사용하는 것이 아니라 필요할 때만 가끔씩 사용하는 부분이 많아졌다. 그러다 보니 자주 사용하지 않고 가끔 사용하는 코드를 커널에 넣지 않고 별도로 보관했다가 필요할 때 호출해 사용한다면, 커널의 크기가 그렇게 크지 않으면서 더 많은 하드웨어를 지원할 수 있을 거싱라는 생각을 하게 되엇다.

### 이렇듯 별도로 보관했다가 필요할 때마다 호출하여 사용하는 코드를 '모듈'이라고 부른다.

### 그렇다면 커널에 넣어야 할 코드와 모듈로 분리해야 할 코드가 CentOS에 설정되어있을 텐데 이 코드들이 과연 내 컴퓨터의 하드웨어에 맞게 원하는 대로 완전히 분리되어 있을까?

### 그렇지 않을 것이다.

### 자주 사용하지 않는 부분은 모듈로 분리하는 것이 더 효율적이지만, CentOS는 설치 시 이 장치를 인식하는 부분을 커널에 넣어 놓았을 수도 있다.

### 이럴 때 커널을 최신 버전으로 업그레이드 하지 않고, 커널에 포함될 것과 모듈로 분리할 것을 사용자가 원하는 대로 지정해 기존의 커널과 똑같은 버전을 다시 컴파일할 수 있다. 이렇게 하면 같은 하드웨어 사양이라도 더 효율적인 성능을 발휘할 수 있다.

### 최근 출시된 하드웨어를 장착했을때 기존의 커널은 지원하지 않지만 최신 커널은 지원할 수 있기 때문이다. 이럴 때 https://www.kernel.org에서 최신 커널 소스를 다운로드 해서 커널을 업그레이드할 필요가 있다. 그 외에 보안 문제 때문에 커널을 업그레이드 하는 경우도 있다.

### 즉 방금 몇몇 사례를 소개했듯이, 커널 컴파일 또는 커널 업그레이드는 주로 하드웨어 지원 문제 때문에 하기 된다.

# <!-- 커널 컴파일 -->

# 커널 컴파일

### 이번에는 CentOS 8 이 기본으로 가진 커널 4.18.0 버전을 최신 커널 버전으로 업그레이드 한다.

### 커널의 실체도 결국 파일이다. CentOS 8의 커널은 /boot/vmlinuz-4.18.0-80.el8.x86_64 다. 이번 실습에서 커널 컴파일 결과는 /boot/vmlinuz-5.3.11 파일이 될 것이다.

### 또 기존 모듈은 /lib/modules/4.18.0-80.el8.x86_64/ 디렉터리에 들어 있다. 새로 컴파일 했을 때의 결과 모듈은 /lib/modules/5.3.11/ 디렉터리가 될 것이다.

## 커널 업그레이드 순서 요약 - 책 272쪽 실습

|     |                         커널 업그레이드 순서                          |              내용              |
| :-: | :-------------------------------------------------------------------: | :----------------------------: |
|  1  |                              # uname -r                               |       현 커널 버전 확인        |
|  2  |       https://www.kernel.org <br> /usr/src에 압축 파일을 옮기자       |       커널 소스 다운로드       |
|  3  |         # tar xfJ linux-5.3.11.tar.xz <br> # cd linux-5.3.11          |      커널 소스 압축 풀기       |
|  4  |                            # make mrproper                            |        커널 설정 초기화        |
|  5  |                            # make xconfig                             |         커널 환경 설정         |
|  6  |                  .config 파일 편집 <br> # make clean                  | .config 편집 및 이전 정보 삭제 |
|  7  | # make <br># make modules_install <br> # make install <br> ls-l /boot |      커널 컴파일 및 설치       |
|  8  |                       # cat /etc/grub2/grub.cfg                       |         부트로더 확인          |

### 만약 실습 중 버전이 너무 많이 올라갔다면 밑의 주소에서 다운을 받자
https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-5.3.11.tar.xz

### 실습 필요 설치 명령어 
dnf -y install make bison flex elfutils-libelf-devel openssl-devel

### make 명령은 커널 컴파일 환경 설정대로 소스 파일을 실제 컴파일하는 과정이며, make modules_install 명령은 컴파일 된 모듈을 /lib/modules/ 디렉터리에 설치하는 과정이고 , make install 명령은 실제 컴파일된 커널을 /boot 디렉터리에 설치하는 과정이다. 그 외에도 새로운 커널을 GRUB2 메뉴에 자동으로 등록해 준다.

|        명령어        |                                                        내용                                                         |
| :------------------: | :-----------------------------------------------------------------------------------------------------------------: |
|         make         |                          명령은 커널 컴파일 환경 설정대로 소스 파일을 실제 컴파일하는 과정                          |
| make modules_install |                               컴파일 된 모듈을 /lib/modules/ 디렉터리에 설치하는 과정                               |
|     make install     | 실제 컴파일된 커널을 /boot 디렉터리에 설치하는 과정이다. 그 외에도 새로운 커널을 GRUB2 메뉴에 자동으로 등록해 준다. |


